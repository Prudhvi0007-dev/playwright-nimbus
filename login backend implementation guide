HttpOnly Cookie Authentication: Implementation Guide

This guide explains how to replace the "simulated" logic in your React app with a real Node.js/Express backend.

1. The Backend (Node.js + Express)

You need a server that handles the Set-Cookie header.

Prerequisites

Initialize a project and install dependencies:

npm init -y
npm install express cookie-parser jsonwebtoken cors


The Server Code (server.js)

Create a file named server.js. This server handles Login (setting the cookie), Logout (clearing the cookie), and a Protected Route (reading the cookie).

const express = require('express');
const jwt = require('jsonwebtoken');
const cookieParser = require('cookie-parser');
const cors = require('cors');

const app = express();
const PORT = 5000;
const SECRET_KEY = "your_super_secret_key_here"; // In production, use .env

// --- MIDDLEWARE ---
app.use(express.json());
app.use(cookieParser()); // Vital: Parses cookies from incoming requests

// CORS Configuration (CRITICAL STEP)
// You MUST specify the origin (your React app's URL) and set credentials: true
app.use(cors({
  origin: 'http://localhost:3000', // Your React App URL
  credentials: true // Allows cookies to be sent/received
}));

// --- ROUTES ---

// 1. LOGIN: Generates Token & Sets Cookie
app.post('/api/login', (req, res) => {
  const { email, password } = req.body;

  // (Simulated DB check)
  if (password !== 'password123') {
    return res.status(401).json({ message: "Invalid credentials" });
  }

  // Create JWT
  const user = { id: 1, email, name: "John Doe" };
  const token = jwt.sign(user, SECRET_KEY, { expiresIn: '1h' });

  // SET THE COOKIE
  res.cookie('auth_token', token, {
    httpOnly: true, // Prevents JavaScript (XSS) from reading this
    secure: process.env.NODE_ENV === 'production', // true if using HTTPS
    sameSite: 'strict', // CSRF protection
    maxAge: 3600000 // 1 hour
  });

  return res.json({ success: true, user });
});

// 2. CHECK SESSION: Validates Cookie on Page Load
app.get('/api/me', (req, res) => {
  const token = req.cookies.auth_token; // Read cookie

  if (!token) return res.status(401).json({ loggedIn: false });

  try {
    const decoded = jwt.verify(token, SECRET_KEY);
    return res.json({ loggedIn: true, user: decoded });
  } catch (err) {
    return res.status(401).json({ loggedIn: false });
  }
});

// 3. LOGOUT: Clears Cookie
app.post('/api/logout', (req, res) => {
  res.clearCookie('auth_token');
  return res.json({ message: "Logged out" });
});

app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));


2. Connecting the React Frontend

You need to modify your React login_page.jsx to speak to this server. The most important setting is credentials: 'include'.

Update the fakeAuthApi function

Replace the setTimeout mock with a real Fetch call:

// Inside your React Component

const realAuthApi = async (email, password) => {
  const response = await fetch('http://localhost:5000/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password }),
    
    // MAGIC SWITCH: This tells browser to accept the 'Set-Cookie' header
    credentials: 'include' 
  });

  if (!response.ok) throw new Error('Login failed');
  
  return await response.json();
};


Update the checkSession useEffect

Replace the mock check with a real call to /api/me.

useEffect(() => {
  const checkSession = async () => {
    try {
      const response = await fetch('http://localhost:5000/api/me', {
        // MAGIC SWITCH: This tells browser to SEND the cookie with the request
        credentials: 'include' 
      });

      if (response.ok) {
        const data = await response.json();
        setCurrentUser(data.user);
        setIsAuthenticated(true);
      }
    } catch (err) {
      setIsAuthenticated(false);
    }
  };
  
  checkSession();
}, []);


3. The "Gotchas" (Troubleshooting)

If it doesn't work, check these 3 things:

CORS Origin: In server.js, cors({ origin: ... }) MUST match your React URL exactly. You cannot use origin: '*' when using credentials: true.

Browser Privacy: Some browsers (like Safari or Chrome Incognito) block "Third-Party Cookies" by default. If your API is on localhost:5000 and React is on localhost:3000, they are considered different origins.

Solution: In development, this usually works on localhost. In production, serve both from the same domain (e.g., myapp.com and api.myapp.com) or use a proxy.

HTTP vs HTTPS: The secure: true flag in the cookie settings REQUIRES https. If you are testing on localhost (http), ensure secure is set to false.
